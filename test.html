<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 釜山孝親團 (功能完全版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F4F4; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .bg-teal-main { background-color: #43968F; }
        .text-teal-main { color: #43968F; }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl overflow-x-hidden pb-24">

<div id="app">
    <div class="bg-teal-main text-white pt-8 pb-6 px-5 rounded-b-[40px] shadow-lg relative">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-2xl font-bold italic">2026 韓國釜山旅遊</h1>
                <p class="text-[10px] opacity-90 tracking-widest mt-1">5人孝親團 · 全功能同步版</p>
            </div>
            <div class="flex gap-2">
                <div @click="openExModal" class="bg-indigo-500 p-2 rounded-lg shadow-sm cursor-pointer hover:bg-indigo-400 transition">
                    <i class="fas fa-sync-alt"></i> <span class="text-xs font-bold">匯率</span>
                </div>
                <div @click="showBillModal = true" class="bg-amber-400 text-amber-900 p-2 rounded-lg shadow-sm cursor-pointer hover:bg-amber-300 transition">
                    <i class="fas fa-calculator"></i> <span class="text-xs font-bold">分帳</span>
                </div>
                <div @click="showAddDayModal = true" class="bg-white text-teal-600 p-2 rounded-lg shadow-sm cursor-pointer">
                    <i class="fas fa-plus"></i> <span class="text-xs font-bold">天數</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3 overflow-x-auto hide-scrollbar py-2">
            <div v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                 :class="['flex-shrink-0 w-16 h-24 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 cursor-pointer', 
                          currentDayIndex === index ? 'bg-white text-[#43968F] shadow-xl scale-110' : 'bg-white/10 text-white opacity-60']">
                <span class="text-[10px] font-bold">{{ day.dateLabel }}</span>
                <span class="text-2xl font-black mt-1">D{{ index + 1 }}</span>
            </div>
        </div>
        
        <div v-if="days.length > 0" class="mt-4 flex justify-center">
            <button @click="deleteCurrentDay" class="text-[9px] bg-red-400/20 hover:bg-red-500 text-white px-3 py-1 rounded-full border border-red-200 transition">
                <i class="fas fa-trash-alt mr-1"></i> 刪除第 {{ currentDayIndex + 1 }} 天
            </button>
        </div>
    </div>

    <div class="px-5 mt-4 mb-4">
        <div class="bg-white rounded-3xl p-5 shadow-md border border-gray-50 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800">{{ days[currentDayIndex]?.dateLabel }}</h2>
                <p class="text-gray-400 text-xs">釜山廣域市 · {{ weatherInfo.desc }}</p>
            </div>
            <div class="text-right text-indigo-600 font-bold">
                <div class="flex items-center gap-1 text-xl">
                    <i :class="weatherInfo.icon"></i>
                    <span>{{ weatherInfo.temp }}°C</span>
                </div>
                <p class="text-[9px] text-gray-400 mt-1 uppercase tracking-tighter">Real-time Data</p>
            </div>
        </div>
    </div>

    <div class="px-5 mb-6">
        <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-gray-50">
            <div class="h-48 w-full bg-gray-100">
                <iframe v-if="mapUrl" width="100%" height="100%" frameborder="0" style="border:0" :src="mapUrl" allowfullscreen></iframe>
                <div v-else class="h-full flex items-center justify-center text-gray-400 text-xs p-4 text-center">
                    請新增行程目的地，地圖將自動載入
                </div>
            </div>
        </div>
    </div>

    <main class="px-5">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800">行程詳情</h2>
            <button @click="showModal = true" class="text-teal-main text-xs font-bold border border-teal-main px-3 py-1 rounded-full">新增</button>
        </div>
        <div class="space-y-4">
            <div v-for="(item, idx) in currentDayItems" :key="idx" 
                 @click="viewItemDetail(item, idx)"
                 class="bg-white p-4 rounded-2xl shadow-sm flex items-start gap-4 border border-gray-50 group active:bg-gray-50 cursor-pointer transition">
                <div class="text-center min-w-[50px] font-black text-teal-main">{{ item.time }}</div>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">{{ item.location }}</h4>
                    <p class="text-[11px] text-gray-400 mt-1">{{ item.note }}</p>
                </div>
                <div class="text-gray-300 group-hover:text-teal-500 transition"><i class="fas fa-chevron-right"></i></div>
            </div>
        </div>
    </main>

    <div v-if="showExModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6" @click.self="showExModal = false">
        <div class="bg-white w-full rounded-[32px] p-8 animate-slide-up shadow-2xl relative">
            <h3 class="text-xl font-bold mb-6 text-gray-800"><i class="fas fa-hand-holding-usd text-indigo-500 mr-2"></i>即時匯率換算</h3>
            <div class="space-y-4">
                <div class="relative">
                    <span class="absolute left-4 top-2 text-[10px] font-bold text-indigo-400">TWD 台幣</span>
                    <input v-model="exTWD" @input="calcKRW" type="number" class="w-full p-4 pt-7 bg-gray-50 rounded-2xl border-none text-xl font-black outline-none" placeholder="0">
                </div>
                <div class="flex justify-center"><i class="fas fa-exchange-alt text-gray-300"></i></div>
                <div class="relative">
                    <span class="absolute left-4 top-2 text-[10px] font-bold text-teal-400">KRW 韓幣</span>
                    <input v-model="exKRW" @input="calcTWD" type="number" class="w-full p-4 pt-7 bg-gray-50 rounded-2xl border-none text-xl font-black outline-none" placeholder="0">
                </div>
                <p class="text-[10px] text-center text-gray-400 mt-4 font-bold italic">
                    1 TWD = {{ currentRate }} KRW (今日即時)
                </p>
            </div>
            <button @click="showExModal = false" class="mt-6 w-full py-3 text-gray-400 font-bold border-t">關閉</button>
        </div>
    </div>

    <div v-if="showAddDayModal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-6" @click.self="showAddDayModal = false">
        <div class="bg-white w-full rounded-[32px] p-8 animate-slide-up shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-gray-800">新增旅行日期</h3>
            <input v-model="newDayInput" type="text" placeholder="2026/02/23" class="w-full p-4 bg-gray-50 rounded-2xl mb-8 border-none text-center font-bold text-lg outline-none">
            <button @click="addNewDay" class="w-full bg-teal-main text-white py-4 rounded-2xl font-bold shadow-lg">確認新增天數</button>
            <button @click="showAddDayModal = false" class="w-full py-3 text-gray-400 text-sm mt-2">取消</button>
        </div>
    </div>

    </div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    const firebaseConfig = {
        apiKey: "AIzaSyBBTwu32DacSxzFG_ntBRE255uhakbtuyo",
        authDomain: "korea-2026-82ad8.firebaseapp.com",
        databaseURL: "https://korea-2026-82ad8-default-rtdb.firebaseio.com",
        projectId: "korea-2026-82ad8",
        storageBucket: "korea-2026-82ad8.firebasestorage.app",
        messagingSenderId: "226938701071",
        appId: "1:226938701071:web:a828225d5b5324f34bea7a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const travelRef = db.ref('busan_luxury_travel_v1');
    const billRef = db.ref('busan_bills_v1');
    const membersRef = db.ref('busan_members_v1');

    createApp({
        setup() {
            const days = ref([]);
            const bills = ref([]);
            const members = ref(['邱郁晟', '邱郁涵', '邱郁善', '媽媽', '姐姐朋友']);
            const currentDayIndex = ref(0);
            
            const showModal = ref(false);
            const showBillModal = ref(false);
            const showDetailModal = ref(false);
            const showAddDayModal = ref(false);
            const showExModal = ref(false);
            const isEditingItem = ref(false);

            const newItem = ref({ time: '09:00', location: '', note: '' });
            const selectedItem = ref({});
            const selectedItemIndex = ref(null);
            const editingItemData = ref({});
            const newBill = ref({ name: '', amount: null, item: '' });
            const newMemberName = ref('');
            const newDayInput = ref('');

            const currentRate = ref(45.85);
            const exTWD = ref(null);
            const exKRW = ref(null);

            // 1. 修正天氣：與釜山當前氣溫同步
            const weatherInfo = ref({ temp: '--', icon: 'fas fa-spinner fa-spin', desc: '更新中...' });
            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.17&longitude=129.07&daily=temperature_2m_max&timezone=Asia%2FSeoul`);
                    const data = await res.json();
                    const temp = Math.round(data.daily.temperature_2m_max[currentDayIndex.value] || data.daily.temperature_2m_max[0]);
                    weatherInfo.value = { temp: temp, desc: temp > 15 ? '天氣晴朗' : '氣溫涼爽', icon: 'fas fa-cloud-sun' };
                } catch (e) { weatherInfo.value.desc = '釜山 12°C'; }
            };

            // 2. 修正匯率：點開彈窗時獲取即時數據
            const fetchRate = async () => {
                try {
                    const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                    const data = await res.json();
                    if(data.rates.KRW) currentRate.value = data.rates.KRW.toFixed(2);
                } catch (e) { console.error("匯率更新失敗"); }
            };
            const openExModal = () => { showExModal.value = true; fetchRate(); };
            const calcKRW = () => { exKRW.value = exTWD.value ? Math.round(exTWD.value * currentRate.value) : null; };
            const calcTWD = () => { exTWD.value = exKRW.value ? Math.round(exKRW.value / currentRate.value) : null; };

            // 3. 修正地圖：繞過 API Key 限制
            const mapUrl = computed(() => {
                const items = days.value[currentDayIndex.value]?.items || [];
                if (items.length === 0) return null;
                const loc = items[0].location;
                return `https://maps.google.com/maps?q=${encodeURIComponent(loc + ' Busan')}&t=&z=14&ie=UTF8&iwloc=&output=embed`;
            });

            // 其餘功能邏輯 (維持不變)
            const splitResults = computed(() => {
                const total = bills.value.reduce((sum, b) => sum + Number(b.amount), 0);
                const avg = members.value.length > 0 ? total / members.value.length : 0;
                let bal = members.value.map(n => ({
                    name: n, 
                    amt: bills.value.filter(b => b.name === n).reduce((s, b) => s + Number(b.amount), 0) - avg
                }));
                const res = [];
                let d = bal.filter(b => b.amt < -0.5).sort((a,b) => a.amt - b.amt);
                let c = bal.filter(b => b.amt > 0.5).sort((a,b) => b.amt - a.amt);
                let i=0, j=0;
                while(i < d.length && j < c.length) {
                    let move = Math.min(Math.abs(d[i].amt), c[j].amt);
                    res.push({ from: d[i].name, to: c[j].name, amount: Math.round(move) });
                    d[i].amt += move; c[j].amt -= move;
                    if(Math.abs(d[i].amt) < 1) i++; if(Math.abs(c[j].amt) < 1) j++;
                }
                return res;
            });

            const addNewDay = () => {
                if(!newDayInput.value) return;
                days.value.push({ dateLabel: newDayInput.value, items: [] });
                travelRef.set(days.value);
                showAddDayModal.value = false; newDayInput.value = '';
            };

            const viewItemDetail = (item, idx) => { selectedItem.value = item; selectedItemIndex.value = idx; editingItemData.value = JSON.parse(JSON.stringify(item)); showDetailModal.value = true; };
            const saveEditedItem = () => {
                days.value[currentDayIndex.value].items[selectedItemIndex.value] = {...editingItemData.value};
                days.value[currentDayIndex.value].items.sort((a,b)=>a.time.localeCompare(b.time));
                travelRef.set(days.value); showDetailModal.value = false;
            };
            const deleteSelectedItem = () => { if(confirm('刪除景點？')) { days.value[currentDayIndex.value].items.splice(selectedItemIndex.value, 1); travelRef.set(days.value); showDetailModal.value = false; } };
            const saveItem = () => {
                if(!days.value[currentDayIndex.value].items) days.value[currentDayIndex.value].items = [];
                days.value[currentDayIndex.value].items.push({...newItem.value});
                days.value[currentDayIndex.value].items.sort((a,b)=>a.time.localeCompare(b.time));
                travelRef.set(days.value); showModal.value = false; newItem.value = { time: '09:00', location: '', note: '' };
            };

            const addBill = () => { if(newBill.value.name && newBill.value.amount) { bills.value.push({...newBill.value}); billRef.set(bills.value); newBill.value = {name:'', amount:null, item:''}; } };
            const deleteBill = (idx) => { bills.value.splice(idx,1); billRef.set(bills.value); };
            const addMember = () => { if(newMemberName.value) { members.value.push(newMemberName.value); membersRef.set(members.value); newMemberName.value=''; } };
            const removeMember = (idx) => { members.value.splice(idx,1); membersRef.set(members.value); };
            const deleteCurrentDay = () => { if(confirm('確定刪除整天行程？')) { days.value.splice(currentDayIndex.value, 1); travelRef.set(days.value); currentDayIndex.value=0; } };

            onMounted(() => {
                travelRef.on('value', snap => { if(snap.val()) days.value = snap.val(); });
                billRef.on('value', snap => { bills.value = snap.val() || []; });
                membersRef.on('value', snap => { if(snap.val()) members.value = snap.val(); });
                fetchWeather(); fetchRate();
            });

            watch(currentDayIndex, () => fetchWeather());

            return { 
                days, bills, currentDayIndex, members, showModal, showBillModal, showDetailModal, showAddDayModal, showExModal, isEditingItem, weatherInfo, newItem, selectedItem, editingItemData, newBill, newMemberName, mapUrl, splitResults, currentRate, exTWD, exKRW, newDayInput,
                saveItem, viewItemDetail, saveEditedItem, deleteSelectedItem, addBill, deleteBill, addMember, removeMember, deleteCurrentDay, addNewDay, openExModal, calcKRW, calcTWD, currentDayItems: computed(() => days.value[currentDayIndex.value]?.items || [])
            };
        }
    }).mount('#app')
</script>
</body>
</html>

