<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 釜山團 (成員管理版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F4F4; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .bg-teal-main { background-color: #43968F; }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl overflow-x-hidden pb-24">

<div id="app">
    <div class="bg-teal-main text-white pt-8 pb-6 px-5 rounded-b-[40px] shadow-lg relative">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold italic">2026 釜山旅遊</h1>
                <p class="text-[10px] opacity-90 tracking-widest mt-1">雲端即時同步 · 成員管理版</p>
            </div>
            <div class="flex gap-2">
                <div @click="showBillModal = true" class="bg-amber-400 text-amber-900 p-2 rounded-lg shadow-sm cursor-pointer hover:bg-amber-300">
                    <i class="fas fa-calculator"></i> <span class="text-xs font-bold">分帳</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3 overflow-x-auto hide-scrollbar py-2">
            <div v-for="(day, index) in days" :key="index" @click="currentDayIndex = index"
                 :class="['flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all', 
                          currentDayIndex === index ? 'bg-white text-[#43968F] shadow-lg scale-105' : 'bg-white/10 text-white opacity-60']">
                <span class="text-[10px]">{{ day.dateLabel }}</span>
                <span class="text-xl font-black">D{{ index + 1 }}</span>
            </div>
        </div>
    </div>

    <div v-if="showBillModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end" @click.self="showBillModal = false">
        <div class="bg-white w-full h-[90vh] rounded-t-[40px] p-6 overflow-y-auto animate-slide-up relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-users mr-2 text-teal-600"></i>旅遊分帳管理</h3>
                <button @click="showBillModal = false" class="text-gray-400 text-2xl">×</button>
            </div>

            <div class="mb-8">
                <h4 class="text-sm font-bold text-gray-500 mb-3 border-l-4 border-teal-500 pl-2">1. 成員名單</h4>
                <div class="flex flex-wrap gap-2 mb-3">
                    <div v-for="(name, index) in members" :key="index" class="bg-teal-50 text-teal-700 px-3 py-1 rounded-full text-sm flex items-center gap-2 border border-teal-100">
                        {{ name }}
                        <i @click="removeMember(index)" class="fas fa-times-circle cursor-pointer text-teal-300 hover:text-red-400"></i>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="newMemberName" type="text" placeholder="輸入新成員姓名" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border-none shadow-inner">
                    <button @click="addMember" class="bg-teal-500 text-white px-4 py-2 rounded-lg text-sm font-bold">新增成員</button>
                </div>
            </div>

            <div class="bg-amber-50 p-4 rounded-2xl mb-8">
                <h4 class="text-xs font-bold text-amber-700 mb-3 underline">新增一筆支出代墊</h4>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select v-model="newBill.name" class="p-3 rounded-xl border-none text-sm shadow-sm bg-white">
                        <option value="" disabled>選擇付款人</option>
                        <option v-for="m in members" :value="m">{{ m }}</option>
                    </select>
                    <input v-model="newBill.amount" type="number" placeholder="金額" class="p-3 rounded-xl border-none text-sm shadow-sm">
                </div>
                <input v-model="newBill.item" type="text" placeholder="項目 (如: 晚餐、車資)" class="w-full p-3 rounded-xl border-none text-sm mb-3 shadow-sm">
                <button @click="addBill" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold hover:bg-amber-600 transition">加入帳目</button>
            </div>

            <div class="mb-8">
                <h4 class="text-sm font-bold text-gray-500 mb-3 border-l-4 border-blue-500 pl-2">2. 個人墊付總計</h4>
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="name in members" :key="name" class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm flex justify-between items-center">
                        <span class="text-xs text-gray-600 font-bold">{{ name }}</span>
                        <span :class="['text-sm font-black', (personalTotals[name] || 0) > 0 ? 'text-teal-600' : 'text-gray-300']">
                            ${{ personalTotals[name] || 0 }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h4 class="text-sm font-bold text-gray-500 mb-3 border-l-4 border-indigo-500 pl-2">3. 結算建議 (每人平分 ${{ Math.round(averageExpense) }})</h4>
                <div class="bg-indigo-50 p-4 rounded-2xl space-y-2">
                    <p v-if="splitResults.length === 0" class="text-xs text-gray-400 text-center py-2 italic">帳目平衡中，暫無須付款</p>
                    <div v-for="res in splitResults" class="flex items-center justify-between text-sm bg-white p-3 rounded-lg shadow-sm border border-indigo-100">
                        <span class="font-bold text-gray-700">{{ res.from }}</span>
                        <span class="text-indigo-600 font-bold">支付 ${{ res.amount }} 給</span>
                        <span class="font-bold text-gray-700">{{ res.to }}</span>
                    </div>
                </div>
            </div>

            <div class="pb-10">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-sm font-bold text-gray-500 border-l-4 border-gray-300 pl-2">4. 支出明細</h4>
                    <button @click="clearBills" class="text-[10px] text-red-500 font-bold">清空帳目</button>
                </div>
                <div class="space-y-2">
                    <div v-for="(b, idx) in bills" :key="idx" class="flex justify-between items-center bg-gray-50 p-3 rounded-xl text-xs border border-gray-100">
                        <div class="flex-1">
                            <span class="font-bold text-teal-700 block">{{ b.name }}</span>
                            <span class="text-gray-500">{{ b.item }}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-black text-gray-700">${{ b.amount }}</span>
                            <button @click="deleteBill(idx)" class="text-red-300 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // Firebase 配置 (請保持您的配置)
    const firebaseConfig = {
        apiKey: "AIzaSyBBTwu32DacSxzFG_ntBRE255uhakbtuyo",
        authDomain: "korea-2026-82ad8.firebaseapp.com",
        databaseURL: "https://korea-2026-82ad8-default-rtdb.firebaseio.com",
        projectId: "korea-2026-82ad8",
        storageBucket: "korea-2026-82ad8.firebasestorage.app",
        messagingSenderId: "226938701071",
        appId: "1:226938701071:web:a828225d5b5324f34bea7a",
        measurementId: "G-K4PC0K55GQ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const billRef = db.ref('busan_bills_v1');
    const memberRef = db.ref('busan_members_v1'); // 新增成員同步路徑

    createApp({
        setup() {
            const days = ref([{dateLabel: '2/23'}, {dateLabel: '2/24'}, {dateLabel: '2/25'}, {dateLabel: '2/26'}, {dateLabel: '2/27'}]);
            const currentDayIndex = ref(0);
            const showBillModal = ref(false);

            // 成員管理
            const members = ref(['邱郁晟', '邱郁涵', '邱郁善', '媽媽', '姐姐朋友']);
            const newMemberName = ref('');

            // 帳目管理
            const bills = ref([]);
            const newBill = ref({ name: '', amount: null, item: '' });

            // 計算：每人墊付總計 (包含 $0)
            const personalTotals = computed(() => {
                const totals = {};
                members.value.forEach(m => totals[m] = 0); // 預設名單所有人都是 0
                bills.value.forEach(b => {
                    if (totals[b.name] !== undefined) {
                        totals[b.name] += Number(b.amount);
                    }
                });
                return totals;
            });

            // 計算：每人平均支出
            const averageExpense = computed(() => {
                const totalAmount = bills.value.reduce((sum, b) => sum + Number(b.amount), 0);
                return members.value.length > 0 ? totalAmount / members.value.length : 0;
            });

            // 結算建議演算法
            const splitResults = computed(() => {
                const avg = averageExpense.value;
                if (avg === 0) return [];

                let balances = members.value.map(name => ({
                    name,
                    bal: (personalTotals.value[name] || 0) - avg
                }));

                const results = [];
                let debtors = balances.filter(b => b.bal < -1).sort((a,b) => a.bal - b.bal);
                let creditors = balances.filter(b => b.bal > 1).sort((a,b) => b.bal - a.bal);

                let i = 0, j = 0;
                while(i < debtors.length && j < creditors.length) {
                    let amount = Math.min(Math.abs(debtors[i].bal), creditors[j].bal);
                    if (amount > 1) {
                        results.push({ from: debtors[i].name, to: creditors[j].name, amount: Math.round(amount) });
                    }
                    debtors[i].bal += amount;
                    creditors[j].bal -= amount;
                    if (Math.abs(debtors[i].bal) < 1) i++;
                    if (Math.abs(creditors[j].bal) < 1) j++;
                }
                return results;
            });

            // 成員動作
            const addMember = () => {
                if (newMemberName.value && !members.value.includes(newMemberName.value)) {
                    members.value.push(newMemberName.value);
                    memberRef.set(members.value);
                    newMemberName.value = '';
                }
            };
            const removeMember = (index) => {
                if (confirm(`確定要移除「${members.value[index]}」嗎？這會影響分帳計算。`)) {
                    members.value.splice(index, 1);
                    memberRef.set(members.value);
                }
            };

            // 帳目動作
            const addBill = () => {
                if (newBill.value.name && newBill.value.amount) {
                    bills.value.push({ ...newBill.value });
                    billRef.set(bills.value);
                    newBill.value = { name: '', amount: null, item: '' };
                }
            };
            const deleteBill = (idx) => {
                if (confirm('確定刪除此筆帳目？')) {
                    bills.value.splice(idx, 1);
                    billRef.set(bills.value);
                }
            };
            const clearBills = () => {
                if (confirm('確定要清空所有帳目重來嗎？')) {
                    bills.value = [];
                    billRef.remove();
                }
            };

            onMounted(() => {
                // 從 Firebase 載入成員與帳目
                memberRef.on('value', snap => {
                    if (snap.val()) members.value = snap.val();
                });
                billRef.on('value', snap => {
                    bills.value = snap.val() || [];
                });
            });

            return { 
                days, currentDayIndex, showBillModal, members, newMemberName, 
                bills, newBill, personalTotals, averageExpense, splitResults,
                addMember, removeMember, addBill, deleteBill, clearBills
            };
        }
    }).mount('#app')
</script>
</body>
</html>
