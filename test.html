<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 釜山孝親團 (含分帳系統)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F4F4; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .bg-teal-main { background-color: #43968F; }
        .text-teal-main { color: #43968F; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl overflow-x-hidden pb-24">

<div id="app">
    <div class="bg-teal-main text-white pt-8 pb-6 px-5 rounded-b-[40px] shadow-lg relative">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-2xl font-bold italic">2026 韓國釜山旅遊</h1>
                <p class="text-[10px] opacity-90 tracking-widest mt-1">5人孝親輕奢團 · 雲端同步</p>
            </div>
            <div class="flex gap-2">
                <div @click="showBillModal = true" class="bg-amber-400 text-amber-900 p-2 rounded-lg shadow-sm cursor-pointer">
                    <i class="fas fa-calculator"></i> <span class="text-xs font-bold">分帳</span>
                </div>
                <div @click="showAddDayModal = true" class="bg-white text-teal-600 p-2 rounded-lg shadow-sm cursor-pointer">
                    <i class="fas fa-plus"></i> <span class="text-xs font-bold">增加天數</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3 overflow-x-auto hide-scrollbar py-2">
            <div v-for="(day, index) in days" :key="index" 
                 @click="currentDayIndex = index"
                 :class="['flex-shrink-0 w-16 h-24 rounded-2xl flex flex-col items-center justify-center transition-all duration-300', 
                          currentDayIndex === index ? 'bg-white text-[#43968F] shadow-xl scale-110' : 'bg-white/10 text-white opacity-60']">
                <span class="text-[10px] uppercase font-bold">{{ day.dateLabel }}</span>
                <span class="text-2xl font-black mt-1">D{{ index + 1 }}</span>
                <span class="text-[9px] mt-1">{{ day.weekDay }}</span>
            </div>
        </div>
        
        <div v-if="days.length > 0" class="mt-4 flex justify-center">
            <button @click="deleteCurrentDay" class="text-[10px] bg-red-400/20 hover:bg-red-500 text-white px-3 py-1 rounded-full border border-red-200 transition">
                <i class="fas fa-trash-alt mr-1"></i> 刪除第 {{ currentDayIndex + 1 }} 天
            </button>
        </div>
    </div>

    <div class="px-5 mt-4 mb-4">
        <div class="bg-white rounded-3xl p-5 shadow-md border border-gray-50 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-800">{{ days[currentDayIndex]?.dateLabel }} {{ days[currentDayIndex]?.weekDay }}</h2>
                <p class="text-gray-400 text-xs">釜山 · {{ weatherInfo.desc }}</p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-1 text-indigo-600 font-bold">
                    <i :class="weatherInfo.icon"></i>
                    <span>{{ weatherInfo.temp }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="px-5 mb-6">
        <div class="bg-white rounded-3xl overflow-hidden card-shadow border border-gray-50">
            <div class="h-48 w-full bg-gray-100 relative">
                <iframe v-if="mapUrl" width="100%" height="100%" frameborder="0" style="border:0" :src="mapUrl" allowfullscreen></iframe>
                <div v-else class="h-full flex items-center justify-center text-gray-400 text-xs p-4 text-center">加入行程後自動生成地圖</div>
            </div>
        </div>
    </div>

    <main class="px-5">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-800">行程詳情</h2>
            <button @click="showModal = true" class="text-teal-main text-xs font-bold border border-teal-main px-3 py-1 rounded-full">新增</button>
        </div>
        <div class="space-y-4">
            <div v-for="(item, idx) in currentDayItems" :key="idx" class="bg-white p-4 rounded-2xl card-shadow flex items-start gap-4 group">
                <div class="text-center min-w-[50px] font-black text-teal-main">{{ item.time }}</div>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-800">{{ item.location }}</h4>
                    <p class="text-[11px] text-gray-400 mt-1">{{ item.note }}</p>
                </div>
                <button @click="deleteItem(idx)" class="text-red-200 group-hover:text-red-400"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </main>

    <div v-if="showBillModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end" @click.self="showBillModal = false">
        <div class="bg-white w-full h-[85vh] rounded-t-[40px] p-6 overflow-y-auto animate-slide-up relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-coins mr-2 text-amber-500"></i>分帳系統</h3>
                <button @click="showBillModal = false" class="text-gray-400 text-2xl">&times;</button>
            </div>

            <div class="bg-amber-50 p-4 rounded-2xl mb-6">
                <p class="text-xs font-bold text-amber-700 mb-3">新增一筆開銷</p>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input v-model="newBill.name" type="text" placeholder="付款人姓名" class="p-3 rounded-xl border-none text-sm">
                    <input v-model="newBill.amount" type="number" placeholder="金額" class="p-3 rounded-xl border-none text-sm">
                </div>
                <input v-model="newBill.item" type="text" placeholder="項目 (例如: 午餐)" class="w-full p-3 rounded-xl border-none text-sm mb-3">
                <button @click="addBill" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-amber-600 transition">加入帳目</button>
            </div>

            <div class="space-y-6">
                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-3 border-l-4 border-amber-500 pl-2">每人代墊總額</h4>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="(total, name) in personalTotals" :key="name" class="bg-white border border-gray-100 p-3 rounded-xl shadow-sm">
                            <span class="text-xs text-gray-400 block">{{ name }}</span>
                            <span class="text-sm font-black text-amber-600">${{ total }}</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-gray-500 mb-3 border-l-4 border-indigo-500 pl-2">分帳建議 (平分)</h4>
                    <div class="bg-indigo-50 p-4 rounded-2xl space-y-2">
                        <p v-if="splitResults.length === 0" class="text-xs text-gray-400 text-center py-2">目前帳目平衡或尚無資料</p>
                        <div v-for="res in splitResults" class="flex items-center justify-between text-sm bg-white p-3 rounded-lg shadow-sm">
                            <span class="font-bold text-gray-700">{{ res.from }}</span>
                            <i class="fas fa-long-arrow-alt-right text-indigo-300"></i>
                            <span class="text-indigo-600 font-bold">${{ res.amount }}</span>
                            <i class="fas fa-long-arrow-alt-right text-indigo-300"></i>
                            <span class="font-bold text-gray-700">{{ res.to }}</span>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-sm font-bold text-gray-500 border-l-4 border-gray-300 pl-2">消費明細</h4>
                        <button @click="clearBills" class="text-[10px] text-red-400 underline">全部清空</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="(b, idx) in bills" :key="idx" class="flex justify-between items-center bg-gray-50 p-3 rounded-xl text-xs">
                            <div>
                                <span class="font-bold text-gray-700 mr-2">{{ b.name }}</span>
                                <span class="text-gray-400">{{ b.item }}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-black text-gray-600">${{ b.amount }}</span>
                                <button @click="deleteBill(idx)" class="text-gray-300"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black/60 z-50 flex items-end" @click.self="showModal = false">
        <div class="bg-white w-full rounded-t-[40px] p-8 animate-slide-up">
            <h3 class="text-xl font-bold text-gray-800 mb-6">新增行程</h3>
            <input v-model="newItem.time" type="time" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 border-none">
            <input v-model="newItem.location" type="text" placeholder="目的地" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 border-none">
            <input v-model="newItem.note" type="text" placeholder="備註" class="w-full p-4 bg-gray-50 rounded-2xl mb-8 border-none">
            <button @click="saveItem" class="w-full bg-teal-main text-white py-4 rounded-2xl font-bold">雲端儲存</button>
        </div>
    </div>

    <div v-if="showAddDayModal" class="fixed inset-0 bg-black/60 z-50 flex items-end" @click.self="showAddDayModal = false">
        <div class="bg-white w-full rounded-t-[40px] p-8 animate-slide-up">
            <h3 class="text-xl font-bold text-gray-800 mb-6">新增天數</h3>
            <input v-model="newDayDate" type="text" placeholder="2/27" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 border-none">
            <input v-model="newDayWeek" type="text" placeholder="(五)" class="w-full p-4 bg-gray-50 rounded-2xl mb-8 border-none">
            <button @click="addNewDay" class="w-full bg-teal-main text-white py-4 rounded-2xl font-bold">確認新增</button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    const firebaseConfig = {
        apiKey: "AIzaSyBBTwu32DacSxzFG_ntBRE255uhakbtuyo",
        authDomain: "korea-2026-82ad8.firebaseapp.com",
        databaseURL: "https://korea-2026-82ad8-default-rtdb.firebaseio.com",
        projectId: "korea-2026-82ad8",
        storageBucket: "korea-2026-82ad8.firebasestorage.app",
        messagingSenderId: "226938701071",
        appId: "1:226938701071:web:a828225d5b5324f34bea7a",
        measurementId: "G-K4PC0K55GQ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const travelRef = db.ref('busan_luxury_travel_v1');
    const billRef = db.ref('busan_bills_v1'); // 分帳專用路徑

    createApp({
        setup() {
            const days = ref([]);
            const bills = ref([]);
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const showAddDayModal = ref(false);
            const showBillModal = ref(false);
            
            const newItem = ref({ time: '09:00', location: '', note: '' });
            const newDayDate = ref('');
            const newDayWeek = ref('');
            const newBill = ref({ name: '', amount: null, item: '' });
            
            const weatherInfo = ref({ temp: '--°', icon: 'fas fa-sun', desc: '多雲時晴' });

            // --- 分帳邏輯 ---
            const personalTotals = computed(() => {
                const totals = {};
                bills.value.forEach(b => {
                    totals[b.name] = (totals[b.name] || 0) + Number(b.amount);
                });
                return totals;
            });

            const splitResults = computed(() => {
                const names = Object.keys(personalTotals.value);
                if (names.length < 2) return [];
                
                const totalAmount = Object.values(personalTotals.value).reduce((a, b) => a + b, 0);
                const avg = totalAmount / names.length;
                
                let balances = names.map(name => ({
                    name,
                    balance: personalTotals.value[name] - avg
                }));

                const results = [];
                const debtors = balances.filter(b => b.balance < -0.1).sort((a,b) => a.balance - b.balance);
                const creditors = balances.filter(b => b.balance > 0.1).sort((a,b) => b.balance - a.balance);

                let d = 0, c = 0;
                while (d < debtors.length && c < creditors.length) {
                    const amount = Math.min(Math.abs(debtors[d].balance), creditors[c].balance);
                    if (amount > 0) {
                        results.push({
                            from: debtors[d].name,
                            to: creditors[c].name,
                            amount: Math.round(amount)
                        });
                    }
                    debtors[d].balance += amount;
                    creditors[c].balance -= amount;
                    if (Math.abs(debtors[d].balance) < 0.1) d++;
                    if (Math.abs(creditors[c].balance) < 0.1) c++;
                }
                return results;
            });

            const addBill = () => {
                if (newBill.value.name && newBill.value.amount) {
                    bills.value.push({ ...newBill.value });
                    billRef.set(bills.value);
                    newBill.value = { name: '', amount: null, item: '' };
                }
            };

            const deleteBill = (idx) => {
                bills.value.splice(idx, 1);
                billRef.set(bills.value);
            };

            const clearBills = () => {
                if(confirm('確定要清空所有帳目嗎？')) {
                    bills.value = [];
                    billRef.set(null);
                }
            };

            // --- 行程邏輯 ---
            onMounted(() => {
                travelRef.on('value', snap => { if(snap.val()) days.value = snap.val(); });
                billRef.on('value', snap => { bills.value = snap.val() || []; });
            });

            const currentDayItems = computed(() => days.value[currentDayIndex.value]?.items || []);
            const mapUrl = computed(() => {
                const locs = currentDayItems.value.map(i => i.location).filter(l => l);
                return locs.length ? `https://www.google.com/maps/dir/My+Location/1{encodeURIComponent(locs.join(' '))}&t=&z=13&ie=UTF8&iwloc=&output=embed` : null;
            });

            const saveItem = () => {
                days.value[currentDayIndex.value].items.push({...newItem.value});
                days.value[currentDayIndex.value].items.sort((a,b) => a.time.localeCompare(b.time));
                travelRef.set(days.value);
                showModal.value = false;
                newItem.value = { time: '09:00', location: '', note: '' };
            };

            const deleteItem = (idx) => {
                days.value[currentDayIndex.value].items.splice(idx, 1);
                travelRef.set(days.value);
            };

            const addNewDay = () => {
                days.value.push({ dateLabel: newDayDate.value, weekDay: newDayWeek.value, items: [] });
                travelRef.set(days.value);
                showAddDayModal.value = false;
            };

            const deleteCurrentDay = () => {
                if (confirm('刪除這天？')) {
                    days.value.splice(currentDayIndex.value, 1);
                    currentDayIndex.value = 0;
                    travelRef.set(days.value);
                }
            };

            const openGoogleMaps = () => window.open(`https://www.google.com/maps/dir/My+Location/2{encodeURIComponent(currentDayItems.value.map(i => i.location).join(' '))}`);

            return { 
                days, bills, currentDayIndex, currentDayItems, showModal, showAddDayModal, showBillModal,
                newItem, newDayDate, newDayWeek, newBill, weatherInfo, mapUrl,
                personalTotals, splitResults, addBill, deleteBill, clearBills,
                saveItem, deleteItem, addNewDay, deleteCurrentDay, openGoogleMaps 
            };
        }
    }).mount('#app')
</script>
</body>
</html>
